version: '3.7'

services:
  rabbitmq:
    image: rabbitmq:latest

  db:
    image: postgres
    environment:
      - POSTGRES_DB=blbackend
      - POSTGRES_USER=blbackend
      - POSTGRES_PASSWORD=blbackend
    volumes:
      - ./postgres_data:/var/lib/postgresql/data/

  memcached:
    container_name: memcached
    image: memcached:latest

  web:
    build: ./
    entrypoint: ./docker-startup/web-entrypoint.sh
    volumes:
      - ./:/usr/src/app/
    ports:
      - 8000:8000
    environment:
      - POSTGRES_DB=blbackend
      - POSTGRES_USER=blbackend
      - POSTGRES_PASSWORD=blbackend
      - DJANGO_SETTINGS_MODULE=blbackend.settings.local_settings
    depends_on:
      - rabbitmq
      - db
      - memcached
    links:
      - memcached
      - db

  celery:
    build: ./
    entrypoint: ./docker-startup/celery-entrypoint.sh
    volumes:
      - ./:/usr/src/app/
    environment:
      - POSTGRES_DB=blbackend
      - POSTGRES_USER=blbackend
      - POSTGRES_PASSWORD=blbackend
      - DJANGO_SETTINGS_MODULE=blbackend.settings.local_settings
    depends_on:
      - web
      - rabbitmq
      - db
    links:
      - memcached
      - rabbitmq
      - db

volumes:
  postgres_data: